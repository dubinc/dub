enum FraudEventStatus {
  pending
  resolved
}

enum FraudRuleType {
  customerEmailMatch
  customerEmailSuspiciousDomain
  referralSourceBanned
  paidTrafficDetected
  partnerCrossProgramBan // Cross-program ban from other programs
  partnerDuplicatePayoutMethod // Duplicate payout method with other partners
  partnerFraudReport // Fraud report from other programs
}

model FraudRule {
  id         String        @id @default(cuid())
  programId  String
  type       FraudRuleType
  config     Json?         @db.Json
  disabledAt DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  program Program? @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, type])
}

model FraudEventGroup {
  id               String           @id @default(cuid())
  programId        String
  partnerId        String
  type             FraudRuleType
  lastEventAt      DateTime?
  eventCount       Int              @default(0)
  userId           String?
  resolutionReason String?          @db.Text
  resolvedAt       DateTime?
  status           FraudEventStatus @default(pending)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  program           Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  partner           Partner           @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  user              User?             @relation(fields: [userId], references: [id])
  programEnrollment ProgramEnrollment @relation(fields: [programId, partnerId], references: [programId, partnerId], onDelete: Cascade)
  fraudEvents       FraudEvent[]

  @@index(programId)
  @@index(partnerId)
  @@index(userId)
}

model FraudEvent {
  id                String   @id @default(cuid())
  fraudEventGroupId String
  linkId            String?
  customerId        String?
  eventId           String?
  fingerprint       String? //  TODO: Make it required after migration
  metadata          Json?    @db.Json
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // DEPRECATED FIELDS: TODO â€“ remove after migration
  programId        String
  partnerId        String
  commissionId     String?
  type             FraudRuleType
  groupKey         String
  userId           String?
  resolutionReason String?          @db.Text
  resolvedAt       DateTime?
  status           FraudEventStatus @default(pending)

  fraudEventGroup FraudEventGroup @relation(fields: [fraudEventGroupId], references: [id], onDelete: Cascade)
  customer        Customer?       @relation(fields: [customerId], references: [id])
  link            Link?           @relation(fields: [linkId], references: [id])

  @@index([programId, partnerId, customerId])
  @@index(partnerId)
  @@index(customerId)
  @@index(linkId)
  @@index(eventId)
  @@index(userId)
  @@index(commissionId)
  @@index(groupKey)
  @@index(fingerprint)
}
