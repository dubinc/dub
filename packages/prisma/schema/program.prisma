enum ProgramEnrollmentStatus {
  pending // pending applications that need approval
  approved // partner who has been approved/actively enrolled
  rejected // program rejected the partner
  invited // partner who has been invited
  declined // partner declined the invite
  deactivated // partner is deactivated by the program
  banned // partner is banned from the program
  archived // partner is archived by the program
}

enum PartnerBannedReason {
  tos_violation
  inappropriate_content
  fake_traffic
  fraud
  spam
  brand_abuse
}

enum ProgramPayoutMode {
  internal // All payouts are handled by Dub
  hybrid // Partners with payouts enabled are paid by Dub, others via external
  external // All payouts are processed through external
}

model Program {
  id                           String            @id @default(cuid())
  workspaceId                  String
  defaultFolderId              String
  defaultGroupId               String
  name                         String
  slug                         String            @unique
  logo                         String?
  wordmark                     String?
  brandColor                   String?
  domain                       String?
  url                          String?
  primaryRewardEvent           EventType         @default(sale)
  holdingPeriodDays            Int               @default(0) // number of days to wait before earnings are added to a payout
  minPayoutAmount              Int               @default(0) // Default minimum payout amount of $0
  embedData                    Json?             @db.Json
  resources                    Json?             @db.Json
  termsUrl                     String?           @db.Text
  helpUrl                      String?           @db.Text
  supportEmail                 String?
  autoApprovePartnersEnabledAt DateTime?
  messagingEnabledAt           DateTime?
  partnerNetworkEnabledAt      DateTime?
  payoutMode                   ProgramPayoutMode @default(internal)
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @updatedAt
  startedAt                    DateTime?

  workspace                Project                   @relation(fields: [workspaceId], references: [id])
  partners                 ProgramEnrollment[]
  payouts                  Payout[]
  invoices                 Invoice[]
  applications             ProgramApplication[]
  links                    Link[]
  commissions              Commission[]
  rewards                  Reward[]
  discounts                Discount[]                @relation("ProgramDiscounts")
  discountCodes            DiscountCode[]
  
  groups                   PartnerGroup[]
  partnerGroupDefaultLinks PartnerGroupDefaultLink[]
  bounties                 Bounty[]
  bountySubmissions        BountySubmission[]
  workflows                Workflow[]
  messages                 Message[]
  comments                 PartnerComment[]

  campaigns                Campaign[]
  emailDomains             EmailDomain[]

  discoveredPartners       DiscoveredPartner[]
  similarPrograms          ProgramSimilarity[]
  similarToPrograms        ProgramSimilarity[] @relation("SimilarProgram")
  categories               ProgramCategory[]

  @@index(workspaceId)
  @@index(domain)
}

model ProgramEnrollment {
  id            String                  @id @default(cuid())
  partnerId     String
  programId     String
  tenantId      String?
  groupId       String?
  applicationId String?                 @unique
  clickRewardId String?
  leadRewardId  String?
  saleRewardId  String?
  discountId    String?
  status        ProgramEnrollmentStatus @default(pending)

  // partner stats
  totalClicks      Int @default(0) // total clicks
  totalLeads       Int @default(0) // total leads
  totalConversions Int @default(0) // total conversions
  totalSales       Int @default(0) // total sales
  totalSaleAmount  Int @default(0) // total sale amount (in cents)
  totalCommissions Int @default(0) // total commissions earned by the partner (in cents)

  // calculated stats
  conversionRate          Float? // totalConversions / totalClicks
  averageLifetimeValue    Float? // totalSaleAmount / totalConversions (in cents)
  leadConversionRate      Float? // totalConversions / totalLeads
  lastConversionAt        DateTime? // latest conversion from partner's links
  daysSinceLastConversion Int? // days since lastConversionAt
  consistencyScore        Int? // based on daysSinceLastConversion

  createdAt                    DateTime             @default(now())
  updatedAt                    DateTime             @updatedAt
  customerDataSharingEnabledAt DateTime?
  bannedAt                     DateTime?
  bannedReason                 PartnerBannedReason?

  partner           Partner             @relation(fields: [partnerId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  program           Program             @relation(fields: [programId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  links             Link[]
  partnerGroup      PartnerGroup?       @relation(fields: [groupId], references: [id])
  application       ProgramApplication? @relation(fields: [applicationId], references: [id])
  clickReward       Reward?             @relation("ClickRewardEnrollments", fields: [clickRewardId], references: [id])
  leadReward        Reward?             @relation("LeadRewardEnrollments", fields: [leadRewardId], references: [id])
  saleReward        Reward?             @relation("SaleRewardEnrollments", fields: [saleRewardId], references: [id])
  discount          Discount?           @relation(fields: [discountId], references: [id])
  bountySubmissions BountySubmission[]
  discountCodes     DiscountCode[]

  // unique constraints
  @@unique([partnerId, programId])
  @@unique([tenantId, programId])
  // indexes for sorting partners
  @@index([programId, status, totalClicks])
  @@index([programId, status, totalLeads])
  @@index([programId, status, totalConversions])
  @@index([programId, status, totalSaleAmount])
  @@index([programId, status, totalCommissions])
  // other indexes
  @@index([groupId, status])
  @@index(clickRewardId)
  @@index(leadRewardId)
  @@index(saleRewardId)
  @@index(discountId)
}

model ProgramApplication {
  id        String   @id @default(cuid())
  programId String
  groupId   String?
  name      String
  email     String
  country   String?
  website   String?  @db.Text
  youtube   String?  @db.Text
  twitter   String?  @db.Text
  linkedin  String?  @db.Text
  instagram String?  @db.Text
  tiktok    String?  @db.Text
  formData  Json?    @db.Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  program      Program            @relation(fields: [programId], references: [id])
  partnerGroup PartnerGroup?      @relation(fields: [groupId], references: [id])
  enrollment   ProgramEnrollment?

  @@index(programId)
  @@index(groupId)
  @@index(email)
}

enum Category {
  Artificial_Intelligence
  Development
  Design
  Productivity
  Finance
  Marketing
  Ecommerce
  Security
  Education
  Health
  Consumer
}
model ProgramCategory {
  programId String
  category  Category

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@unique([programId, category])
}
